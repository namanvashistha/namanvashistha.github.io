name: Deploy to GitHub Pages

on:
    push:
        branches: [main]
    workflow_dispatch:

permissions:
    contents: write  # Need write permission to commit PDFs
    pages: write
    id-token: write

concurrency:
    group: "pages"
    cancel-in-progress: false

jobs:
    build:
        runs-on: ubuntu-latest
        # Skip if commit is from bot (PDF auto-commit)
        if: github.event.head_commit.author.name != 'github-actions[bot]'
        steps:
            - name: Checkout
              uses: actions/checkout@v4
              with:
                  fetch-depth: 2  # Need history to check for changes
                  token: ${{ secrets.GITHUB_TOKEN }}
                  persist-credentials: true

            - name: Check for resume changes
              id: resume_check
              run: |
                  if git diff --name-only HEAD~1 HEAD | grep -q '^resume/'; then
                    echo "changed=true" >> $GITHUB_OUTPUT
                    echo "Resume files changed, will generate PDFs"
                  else
                    echo "changed=false" >> $GITHUB_OUTPUT
                    echo "No resume changes, skipping PDF generation"
                  fi

            - name: Setup uv
              if: steps.resume_check.outputs.changed == 'true'
              uses: astral-sh/setup-uv@v5
              with:
                  enable-cache: true

            - name: Install LaTeX
              if: steps.resume_check.outputs.changed == 'true'
              run: |
                  sudo apt-get update -qq
                  sudo apt-get install -y texlive-latex-base texlive-latex-extra texlive-fonts-recommended texlive-fonts-extra

            - name: Setup Bun
              uses: oven-sh/setup-bun@v1
              with:
                  bun-version: 1.3.8

            - name: Install dependencies
              run: bun install

            - name: Build site
              run: bun run build
              env:
                GISCUS_REPO: namanvashistha/namanvashistha.github.io
                GISCUS_REPO_ID: MDEwOlJlcG9zaXRvcnkxMjYxOTIwNjc=
                GISCUS_CATEGORY: Comments
                GISCUS_CATEGORY_ID: DIC_kwDOB4WJw84C2tvv
                GISCUS_MAPPING: pathname
                GISCUS_STRICT: "false"
                GISCUS_REACTIONS_ENABLED: "true"
                GISCUS_EMIT_METADATA: "false"
                GISCUS_LANG: en
                UMAMI_WEBSITE_ID:"7fbb5129-4232-411d-aa56-d577f6d182de"

            - name: Generate Resume PDFs (to public/ and dist/)
              if: steps.resume_check.outputs.changed == 'true'
              run: |
                  cd resume
                  for profile in profiles/*.json; do
                      echo "Generating PDF for $(basename $profile)"
                      uv run generate.py "$profile"
                  done
                  echo "PDFs generated and copied"
                  ls -lh ../public/resume*.pdf 2>/dev/null || true
                  ls -lh ../dist/resume*.pdf 2>/dev/null || true

            - name: Commit PDFs to public/
              if: steps.resume_check.outputs.changed == 'true'
              run: |
                  git config user.name "github-actions[bot]"
                  git config user.email "github-actions[bot]@users.noreply.github.com"
                  git add public/resume*.pdf
                  if git diff --staged --quiet; then
                    echo "No PDF changes to commit"
                  else
                    git commit -m "chore: update resume PDFs [skip ci]"
                    git push
                    echo "PDFs committed to public/"
                  fi

            - name: Upload artifact
              uses: actions/upload-pages-artifact@v3
              with:
                  path: ./dist

    deploy:
        environment:
            name: github-pages
            url: ${{ steps.deployment.outputs.page_url }}
        runs-on: ubuntu-latest
        needs: build
        steps:
            - name: Deploy to GitHub Pages
              id: deployment
              uses: actions/deploy-pages@v4
