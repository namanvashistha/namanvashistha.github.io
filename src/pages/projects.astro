---
import '../styles/article-list.css';

import { Image } from 'astro:assets';
import { getCollection } from 'astro:content';
import { openGraph } from 'spectre:globals';
import Card from '../components/Card.astro';
import Icon from '../components/Icon.astro';
import Layout from '../layouts/Layout.astro';

const projects = await getCollection('projects');
const tags = projects.flatMap((project) => project.data.tags ? project.data.tags.map((tag: any) => tag.id) : []);
---
<Layout
	title={openGraph.projects.title || "Projects"}
	description={openGraph.projects.description}
	pagefindIgnore
>
  <div class="layout-grid-left" slot="left">
    <Card class="flex-col-card">
      <h2 class="no-mt">Stats</h2>
			<div class="stats-div">
				<div class="stat">
					<h3 class="text-glow">{projects.length}</h3>
					<span>Project{projects.length === 1 ? '' : 's'}</span>
				</div>
			</div>
    </Card>
    <Card class="flex-col-card">
      <h2 class="no-mt">Filter</h2>
      <ul class="tags-list" role="group" aria-label="Filter projects by tag">
        {Array.from(new Set(tags)).map((tag) => (
          <li>
            <a
              class="project-tag"
              href="/projects"
              data-tag={tag}
              role="button"
              aria-pressed="false"
            >
              {tag}
            </a>
          </li>
        ))}
      </ul>
    </Card>
  </div>
  <div class="layout-grid-right" slot="right">
		<Card>
			<div class="header-container">
				<Icon type='lucide' name="folder-git" width={24} height={24} class='glow-icon' />
				<h2>Latest Projects</h2>
			</div>
			<div class="content-container">
				{projects.sort((a, b) => b.data.date.getTime() - a.data.date.getTime()).map((post) => (
					<a href={`/projects/${post.id}`} class="post-container" data-tags={post.data.tags ? post.data.tags.map((tag: any) => tag.id).join(",") : ""}>
						<Image
							src={post.data.image}
							alt={post.data.title}
							width={240}
							class="post-cover-image"
							loading="lazy"
						/>
						<div class="post-text-content">
							<div class="post-header">
								<h3>{post.data.title}</h3>
								<span class="post-date">{post.data.date.toLocaleDateString()}</span>
							</div>
							<span>{post.data.description}</span>
						</div>
					</a>
				))}
			</div>
		</Card>
  </div>
</Layout>
<script>
  const tags = document.querySelectorAll<HTMLAnchorElement>('.project-tag');
  const posts = document.querySelectorAll<HTMLAnchorElement>('.post-container');
  const url = new URL(window.location.href);
  const initialTags = url.searchParams.get('tags')?.split(',').filter((tag) => tag.length > 0) || [];
  const selectedTags = new Set(initialTags);

  function updatePostsVisibility() {
    posts.forEach((post) => {
      const postTags = post.dataset.tags ? post.dataset.tags.split(',') : [];
      // if there are selected tags and the post does not have all of them, hide the post
      if (selectedTags.size > 0 && ![...selectedTags].every((tag) => postTags.includes(tag))) {
        post.style.display = 'none';
      } else {
        post.style.display = '';
      }
    });
  }

  function updateURL() {
    // create a "clean" URL for the current page before adding the new query parameters
    const newUrl = new URL(window.location.pathname, window.location.origin);
    if (selectedTags.size > 0) {
      newUrl.searchParams.set('tags', [...selectedTags].join(','));
    }
    history.pushState({ tags: [...selectedTags] }, '', newUrl);
  }

  tags.forEach((tag) => {
    const tagValue = tag.dataset.tag!;
    if (selectedTags.has(tagValue)) {
      tag.classList.add('active');
    }

    tag.addEventListener('click', (event) => {
      event.preventDefault();

      tag.classList.toggle('active');

      if (selectedTags.has(tagValue)) {
        selectedTags.delete(tagValue);
        tag.setAttribute('aria-pressed', 'false');
      } else {
        selectedTags.add(tagValue);
        tag.setAttribute('aria-pressed', 'true');
      }

      updatePostsVisibility();
      updateURL();
    });
  });

  updatePostsVisibility();
</script>
<style>
	.stats-div {
		display: flex;
		flex-direction: column;
		gap: 1rem;
	}

	.stat {
		display: flex;
		flex-direction: column;
	}

	.stat h3 {
		font-size: 2em;
		margin: 0;
		margin-bottom: .5rem;
	}

</style>
