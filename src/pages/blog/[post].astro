---
import '../../styles/article.css';

import type { CollectionEntry } from 'astro:content';
import { getCollection, render } from 'astro:content';
import { giscus } from 'spectre:globals';
import type { GetStaticPaths } from 'astro';
import Card from '../../components/Card.astro';
import ImageGlow from '../../components/ImageGlow.astro';
import Layout from '../../layouts/Layout.astro';

/**
 * Estimates the time it takes to read a post in minutes based on:
 * - A reading speed of 200 words per minute
 * - 10 seconds per image
 * - 20 seconds per code block
 *
 * @param post The post to estimate the reading time for
 */
function timeToRead(post: CollectionEntry<'posts'>): number {
	const numWords = (post.body || '')
		.replace(/.*\[(.*?)\].*/gm, '$1')
		.replace(/```.*?```/gms, '')
		.split(/\s+/).length;

	const numImages = post.body?.match(/!\[/g)?.length || 0;
	const numCodeblocks = post.body?.match(/```/g)?.length || 0;

	return Math.ceil(numWords / 200) + Math.ceil(numImages / 6) + Math.ceil(numCodeblocks / 3);
}

interface Props {
	post: CollectionEntry<'posts'>;
}

const { post } = Astro.props;

export const getStaticPaths = (async () => {
	const posts = await getCollection('posts', (post) => post.data.draft !== true);

	return posts.map((post) => ({ params: { post: post.id }, props: { post } }));
}) satisfies GetStaticPaths;

const { Content, headings } = await render(post);
---

<Layout
  title={post.data.title}
  description={post.data.description}
  image={post.data.image}
  article={{
    createdAt: post.data.createdAt,
    updatedAt: post.data.updatedAt,
  }}
>
  <div class="left" slot="left">
    <Card class="toc-card">
      <nav aria-label="Table of contents">
      <h2 class="no-mt">Table of contents</h2>
      <ol>
        <li class="toc-li">
          <a href={`#_top`} class="active">{post.data.title}</a>
        </li>
        {headings.map((heading, i) => (
          <li class="toc-li" data-depth={heading.depth}>
            <a href={`#${heading.slug}`}>{heading.text}</a>
          </li>
        ))}
      </ol>
      </nav>
    </Card>
  </div>
  <article slot="right" data-pagefind-body>
    <Card>
      <div class="article-header" id="_top" data-pagefind-ignore>
        <ImageGlow quality={100} class="article-image" src={post.data.image} alt={post.data.title} />
        <div class="header">
          <div>
            <h1 class="no-mt article-h1" data-pagefind-weight="10">{post.data.title}</h1>
          </div>
          <div class="article-info">
            <span>{post.data.createdAt.toLocaleDateString('en-GB')}</span>
            <span>/</span>
            <span>{timeToRead(post)} minute{timeToRead(post) === 1 ? "" : "s"} read</span>
            <span>/</span>
            <span>Tags: {post.data.tags.map((tag) => tag.id).join(", ")}</span>
            <span>/</span>
            <span class="hits-label">Views:</span>
            <img
              src={`https://hits.sh/namanvashistha.com/blog/${post.id}.svg?style=flat-square&label=&#8203;&color=8c5cf5&labelColor=1a1a1a&extraCount=100`}
              alt="view count"
              height="18"
              class="hits-badge"
            />
          </div>
        </div>
      </div>
      <Content />
      <hr class="end-of-article" />
      <a href="/blog" class="block-link" data-pagefind-ignore>‚Üê Back to blog</a>
    </Card>
    {giscus && (
      <Card>
        <div class="comments" id="giscus-container" data-pagefind-ignore>
          {/* Giscus will be injected here dynamically */}
        </div>
        <script is:inline define:vars={{ giscus }}>
          function loadGiscus() {
            const container = document.getElementById('giscus-container');
            if (!container) return;
            
            // Clear any existing comments to prevent duplicates
            container.innerHTML = '';
            
            const script = document.createElement('script');
            script.src = 'https://giscus.app/client.js';
            script.setAttribute('data-repo', giscus.repository);
            script.setAttribute('data-repo-id', giscus.repositoryId);
            script.setAttribute('data-category', giscus.category);
            script.setAttribute('data-category-id', giscus.categoryId);
            script.setAttribute('data-mapping', giscus.mapping);
            script.setAttribute('data-strict', giscus.strict === true ? "1" : "0");
            script.setAttribute('data-reactions-enabled', giscus.reactionsEnabled === true ? "1" : "0");
            script.setAttribute('data-emit-metadata', giscus.emitMetadata === true ? "1" : "0");
            script.setAttribute('data-input-position', giscus.commentsInput);
            script.setAttribute('data-theme', giscus.theme || "https://spectre.lou.gg/styles/giscus");
            script.setAttribute('data-lang', giscus.lang);
            script.setAttribute('crossorigin', 'anonymous');
            script.async = true;
            
            container.appendChild(script);
          }

          // Load on first visit and subsequent View Transitions navigations
          document.addEventListener('astro:page-load', loadGiscus);
        </script>
      </Card>
    )}
  </article>
</Layout>
<script src="../../scripts/toc.ts" />
<style is:global>
  .toc-card ol {
    padding: 0;
    display: flex;
    flex-direction: column;
    gap: .5rem;
    margin-bottom: 0;
    list-style-type: none;
    position: relative;
  }

  .toc-card ol li a {
    color: #c7c7c7;
    font-size: .925rem;
    padding: .25rem .5rem;
    box-decoration-break: clone;
    -webkit-box-decoration-break: clone;
  }

  .toc-card ol li a:hover {
    color: white;
    text-decoration: none;
  }

  .toc-card ol li a.active {
    color: white;
    background: var(--primary);
  }

  .left {
    height: 100%;
    position: relative;
  }

  .toc-card {
    position: sticky;
    top: 2rem;
  }

  article {
    display: flex;
    flex-direction: column;
    gap: 2rem;
  }

  .comments * {
    border-color: #353535 !important;
  }



  @media screen and (max-width: 640px) {
    article {
      gap: 1rem;
    }
  }

</style>
